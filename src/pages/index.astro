---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import Navigation from '../components/Navigation.astro';
import WorkSection from '../components/WorkSection.astro';
import FeaturedProjects from '../components/FeaturedProjects.astro';
import ThoughtsSection from '../components/ThoughtsSection.astro';
import ConnectSection from '../components/ConnectSection.astro';
import Footer from '../components/Footer.astro';
import { getEntry, getCollection } from 'astro:content';

// Get portfolio content from markdown file
const portfolioEntry = await getEntry('portfolio', 'main');
const portfolio = portfolioEntry.data;

// Get blog posts for Recent Thoughts section
const allBlogPosts = await getCollection('blog');
const publishedPosts = allBlogPosts
  .filter(post => post.data.published)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 4); // Get latest 4 posts

// Transform blog posts for ThoughtsSection component
const recentThoughts = publishedPosts.map(post => ({
  title: post.data.title,
  excerpt: post.data.excerpt,
  date: post.data.date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
  readTime: post.data.readTime,
  slug: post.slug,
}));

// Get work projects from the new work collection
const allWorkProjects = await getCollection('work');
const featuredWork = allWorkProjects
  .filter(work => work.data.featured)
  .sort((a, b) => (a.data.order || 999) - (b.data.order || 999));

// Transform work data to match component expectations
const workData = featuredWork.map(work => ({
	year: work.data.year,
	role: work.data.role,
	company: work.data.company,
	description: work.data.description,
	tech: work.data.technologies,
	slug: work.slug, // Add slug for navigation
}));
---

<Layout title="Portfolio Template">
	<div class="min-h-screen bg-background text-foreground relative">
		<Navigation />
		<main class="max-w-4xl mx-auto px-6 sm:px-8 lg:px-16">
			<header
				id="intro"
				data-section="intro"
				class="min-h-screen flex items-center opacity-0"
			>
				<Hero
					portfolioYear={portfolio.portfolioYear}
					firstName={portfolio.firstName}
					lastName={portfolio.lastName}
					description={portfolio.description}
					location={portfolio.location}
					skills={portfolio.skills}
					currentRole={portfolio.currentRole.title}
					currentCompany={portfolio.currentRole.company}
					currentDuration={portfolio.currentRole.duration}
				/>
			</header>

			<section
				id="projects"
				data-section="projects"
				class="min-h-screen py-20 sm:py-32 opacity-0"
			>
				<FeaturedProjects />
			</section>

			<section
				id="work"
				data-section="work"
				class="min-h-screen py-20 sm:py-32 opacity-0"
			>
				<WorkSection
					title={portfolio.workSection.title}
					dateRange={portfolio.workSection.dateRange}
					jobs={workData}
				/>
			</section>

			<section
				id="thoughts"
				data-section="thoughts"
				class="min-h-screen py-20 sm:py-32 opacity-0"
			>
				<ThoughtsSection posts={recentThoughts} />
			</section>

			<section
				id="connect"
				data-section="connect"
				class="py-20 sm:py-32 opacity-0"
			>
				<ConnectSection
					title={portfolio.connectTitle}
					description={portfolio.connectDescription}
					email={portfolio.email}
					socialLinks={portfolio.socialLinks}
				/>
			</section>

			<Footer
				copyright={portfolio.footer.copyright}
				attribution={portfolio.footer.attribution}
				year={portfolio.footer.year}
			/>
		</main>

		<div class="fixed bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-background via-background/80 to-transparent pointer-events-none"></div>
	</div>
</Layout>
